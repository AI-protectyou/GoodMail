<!DOCTYPE html>
<html dir="ltr" lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Good Mail 목록</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../static/css/mail_list_pages.css" />
    <link rel="stylesheet" href="../static/css/pretendard.css" />
  </head>

  <body>
    <header id="logo_header">
      <div class="userEmail">
        <div id="userEmail">{{ user_email }}</div>
        <button id="logoutButton"></button>
      </div>
      <div class="logo_search">
        <img id="medium_logo" src="../static/images/logo.png" />
        <div id="search_field">
          <img src="../static/images/search.png" />
          <input type="search" placeholder="메일 검색" name="query" />
        </div>
      </div>
    </header>
    <section id="mail_list">
      <nav>
        <div class="left_group">
          <ul>정렬:</ul>
          <ul>
            <select>
              <option value="chronological" selected>시간순</option>
              <option value="sender">이름순</option>
            </select>
          </ul>
          <ul>
            <select>
              <option value="descending" selected>내림차순</option>
              <option value="ascending">오름차순</option>
            </select>
          </ul>
          <ul>
            <input class="button" type="button" value="새로고침 (F5)" />
          </ul>
        </div>
        <div class="right_group">
          <ul>
            <input type="button" id="get_mail" value="전체 메일 보기" />
          </ul>
          <ul>
            <input type="button" value="AI 필터링 실행" />
          </ul>
        </div>
      </nav>
      <main>
        <div id="mails"></div>
      </main>
      <div id="mail_list_paging">
        <div class="buttons">
          <input type="button" id="leftmost" />
          <input type="button" id="left" />
          <input type="button" id="line" disabled />
          <input type="button" id="right" />
          <input type="button" id="rightmost" />
        </div>
        <div class="text">1 / N 페이지</div>
      </div>
    </section>

    <script>
  async function fetchEmails() {
    try {
      const response = await fetch('/api/mail', {
        method: 'GET'
      });

      if (!response.ok) {
        throw new Error('메일 목록 출력 실패!');
      }

      const data = await response.json();

      if (data.status === 'updating') {
        // 업데이트 중인 경우, 5초 후 다시 시도
        console.log('업데이트 중, 잠시 후 다시 시도합니다...');
        setTimeout(fetchEmails, 5000);
        return;
      }

      const mailsDiv = document.getElementById('mails');
      mailsDiv.innerHTML = ''; // 기존 내용을 비움

      // data.emails가 올바르게 가져오도록 수정
      data.emails.forEach((email) => {
        const mailItem = document.createElement('div');
        mailItem.textContent = email.subject;
        mailsDiv.appendChild(mailItem);
      });

    } catch (error) {
      console.error('데이터 가져오기 실패:', error);
      setTimeout(fetchEmails, 5000); // 실패 시 5초 후 재시도
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    fetchEmails();
  });

  document.getElementById('get_mail').addEventListener('click', () => {
    console.log('전체 메일 보기 클릭');
    fetchEmails();
  });

  document.querySelector('input[type="search"]').addEventListener('keydown', (evt) => {
    if (evt.key === 'Enter') {
      let query = evt.target.value;
      console.log(evt);
      if (query.length > 1) {
        // 백엔드에서 검색 요청 추가
      } else {
        alert('검색 실패! 두 글자 이상 입력해주세요.');
      }
    }
  });

  document.getElementById('logoutButton').addEventListener('click', function () {
    console.log('로그아웃 눌림');
    fetch('/api/logout', {
      method: 'POST'
    }).then(function (response) {
      if (response.ok) {
        window.location.href = '/login'; // 로그인 페이지로 이동
      }
    });
  });
</script>

  </body>
</html>
